#!/usr/bin/env bash

myDir=$(pwd)
cd $myDir || { echo "Cannot get to my ${myDir}, exiting."; exit 3; }

init=""
while [[ $1 ]]; do
    case $1 in
        init)
            init="yes"
            shift
            ;;
    esac
done

workingIn=$(basename $myDir)
case $workingIn in
    myBinFiles)
        compareWith=~/bin
        if [[ ! -f $compareWith ]]; then
            mkdir -p $compareWith
        fi
        ;;
    myDotFiles)
        compareWith=~
        ;;
    *)
        echo "Is '$myDir' the right place to be?"
        exit 1
        ;;
esac

theManifest=${myDir}/manifest
[[ ! -s ${theManifest} ]] && { echo "No manifest, very odd, exiting."; exit 5; }

# this sets fileManifest
source "${theManifest}" || { echo "Cannot source '${theManifest}', exiting."; exit 7; }

# everything should be good to go now; get defensive
set -u

diffColorOption () {
    if diff --color=always . . 2> /dev/null; then
        echo "--color=always"
    else
        echo ""
    fi
}

replaceOrSwap () {
    anyDiffs=yes
    diff $(diffColorOption) -u ${compareWith}/${file} ${myDir}/${file}
    echo; echo "If + is wanted, 'y'; if - is wanted, 'swap'; 'd' deletes '-'; otherwise, anything else."
    read -p "Replace $file in ~? " answer
    case $answer in
        y*|Y*)
            makeOrUpdate
            ;;
        swap)
            replace
            ;;
        d)
            rm ${myHome}/${file}
            ;;
        *)
            :
            ;;
    esac
}

replace () {
    cp -p ${compareWith}/${file} ${myDir}/${file} || echo Error copying!!!
}

makeOrUpdate () {
    cp -p ${myDir}/${file} ${compareWith}/${file} || echo Error copying!!!
}

addMissing () {
    doIt="no"
    anyDiffs=yes
    if [[ "yes" == $init ]]; then
        doIt="yes"
    else
        echo "The file '${compareWith}/${file}' does not exist;"
        read -p "createit from '${myDir}/${file}'? " answer
        case $answer in
            y*|Y*)
                doIt="yes"
                ;;
            *)
                :
                ;;
        esac
    fi
    [[ "yes" == $doIt ]] && makeOrUpdate
}

anyDiffs=no
for file in $fileManifest; do
    [[ ! -f ${compareWith}/${file} ]] && { addMissing; continue; }
    diff -q ${compareWith}/${file} ${myDir}/${file} 2> /dev/null || { replaceOrSwap; continue; }
done

[[ ${anyDiffs} = no ]] && { echo "No diffs, no need to change anything."; git status; } || true

